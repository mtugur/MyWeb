@model MyWeb.WebApp.Controllers.HistoryUiController.TrendVm
@{
    ViewData["Title"] = "Trend";
}

<div class="row mb-3">
    <div class="col">
        <h4>Basit Trend</h4>
        @if (ViewData["Error"] is string err)
        {
            <div class="alert alert-warning">@err</div>
        }
    </div>
</div>

<div class="row g-3 align-items-end">
    <div class="col-md-3">
        <label class="form-label">Proje</label>
        <select class="form-select" id="projectSelect">
            @foreach (var p in Model.Projects)
            {
                <option value="@p.Id" selected="@(p.Id == Model.SelectedProjectId)">@p.Name (@p.Key)</option>
            }
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Tag</label>
        <select class="form-select" id="tagSelect">
            @foreach (var t in Model.Tags)
            {
                <option value="@t.Id">@t.Path</option>
            }
        </select>
        @if (Model.Tags.Count == 0)
        {
            <small class="text-muted">Bu projede tag bulunamadı.</small>
        }
    </div>
    <div class="col-md-2">
        <label class="form-label">Başlangıç</label>
        <input type="datetime-local" class="form-control" id="fromInput" />
    </div>
    <div class="col-md-2">
        <label class="form-label">Bitiş</label>
        <input type="datetime-local" class="form-control" id="toInput" />
    </div>
    <div class="col-md-1">
        <button id="btnFetch" class="btn btn-primary w-100">Getir</button>
    </div>
</div>

<hr class="my-4" />

<!-- Sabit ve makul bir yükseklik veriyoruz; Chart.js aspect ratio’yu zorlamasın -->
<div id="trendWrap" style="height:420px; position:relative;">
    <canvas id="trendChart" style="height:400px;"></canvas>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="~/js/history-trend.js" asp-append-version="true"></script>
    <script>
        // varsayılan aralık: son 24 saat (dün-bugün kıvamında çalışsın)
        (function initDefaults(){
            const to = new Date();
            const from = new Date(to.getTime() - 24*60*60*1000);
            const fmt = (d)=> new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
            document.getElementById('fromInput').value = fmt(from);
            document.getElementById('toInput').value = fmt(to);
        })();

        window.HISTORY_TREND_BOOT && window.HISTORY_TREND_BOOT({
            endpoints: {
                samples: (tagId, fromIso, toIso, take) =>
                    `/api/hist/samples?tagId=${tagId}&from=${encodeURIComponent(fromIso)}&to=${encodeURIComponent(toIso)}&take=${take ?? 5000}`
            }
        });
    </script>
}
